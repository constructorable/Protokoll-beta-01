// limittextfields.js - Text Input Field Character Limit Monitor f√ºr Bemerkungsfelder
// √úberwacht alle .bemerkung-input Felder auf 80-Zeichen-Limit

class BemerkungTextLimitMonitor {
    constructor() {
        this.characterLimit = 80;
        this.warningThreshold = 75;
        this.monitoredFields = new Set();
        this.activeField = null;
        this.isInitialized = false;
        
        console.log('üöÄ BemerkungTextLimitMonitor wird initialisiert...');
        
        // Warte bis DOM geladen ist
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => this.initialize());
        } else {
            this.initialize();
        }
    }

    // Initialisierung nach DOM-Load
    initialize() {
        console.log('üìã Initialize gestartet');
        
        // WICHTIG: Modal sofort verstecken bei Initialisierung
        this.forceHideModal();
        
        this.setupModalEventListeners();
        this.initializeMonitoring();
        this.setupDynamicFieldObserver();
        
        this.isInitialized = true;
        console.log('‚úÖ Initialize abgeschlossen');
    }

    // Modal zwangsweise verstecken
    forceHideModal() {
        const modal = document.getElementById('bemerkungLimitModal');
        if (modal) {
            console.log(`üîí Modal gefunden - erzwinge Verstecken`);
            console.log(`Modal aktueller Display-Wert: "${modal.style.display}"`);
            console.log(`Modal computed Display-Wert: "${window.getComputedStyle(modal).display}"`);
            
            // Mehrere Methoden um sicherzustellen dass Modal versteckt ist
            modal.style.display = 'none !important';
            modal.style.visibility = 'hidden';
            modal.classList.remove('show');
            modal.setAttribute('style', 'display: none !important; visibility: hidden;');
            
            document.body.classList.remove('bemerkung-modal-open');
            
            console.log(`üîí Modal versteckt - neuer Display-Wert: "${modal.style.display}"`);
        } else {
            console.error('‚ùå Modal Element "bemerkungLimitModal" nicht im HTML gefunden!');
        }
    }

    // Initialisierung f√ºr alle existierenden Bemerkungsfelder
    initializeMonitoring() {
        const bemerkungFields = document.querySelectorAll('.bemerkung-input');
        console.log(`üîç Gefundene Bemerkungsfelder: ${bemerkungFields.length}`);
        
        bemerkungFields.forEach((field, index) => {
            const fieldValue = field.value || '';
            const fieldLength = fieldValue.length;
            
       
            
            // Warnmeldung wenn Feld bereits √ºber Limit
            if (fieldLength > this.characterLimit) {
                console.warn(`‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è FELD BEREITS √úBER LIMIT BEI INITIALISIERUNG!`);

            }
            
            this.addFieldMonitoring(field);
        });
        
        if (bemerkungFields.length === 0) {
            console.log('‚ÑπÔ∏è Keine Bemerkungsfelder gefunden - das ist normal wenn noch keine erstellt wurden');
        }
    }

    // √úberwachung f√ºr ein Bemerkungsfeld hinzuf√ºgen
    addFieldMonitoring(inputField) {
        if (this.monitoredFields.has(inputField)) {
            console.log(`‚ôªÔ∏è Feld bereits √ºberwacht: ${inputField.id}`);
            return;
        }
        
        this.monitoredFields.add(inputField);
   
        
        // Event Listeners
        inputField.addEventListener('focus', (event) => this.handleFieldFocus(event));
        inputField.addEventListener('blur', (event) => this.handleFieldBlur(event));
        inputField.addEventListener('input', (event) => this.handleBemerkungInput(event));
        inputField.addEventListener('paste', (event) => this.handlePasteEvent(event));
        inputField.addEventListener('keydown', (event) => this.handleKeyDown(event));
    }

    // Focus Event Handler
    handleFieldFocus(event) {
        this.activeField = event.target;
        const fieldValue = event.target.value || '';
        
        console.log(`üéØ Feld fokussiert: ${event.target.id}`);
        console.log(`   - Wert: "${fieldValue}"`);
        console.log(`   - L√§nge: ${fieldValue.length} Zeichen`);
        
        // NUR Modal anzeigen wenn bereits √ºber Limit UND das System initialisiert ist
        if (this.isInitialized && fieldValue.length > this.characterLimit) {
            console.warn(`üö® FELD √úBER LIMIT BEI FOCUS!`);
            console.warn(`   - Feld: ${event.target.id}`);
            console.warn(`   - L√§nge: ${fieldValue.length} Zeichen`);
            console.warn(`   - System initialisiert: ${this.isInitialized}`);
            console.warn(`   ‚û°Ô∏è ZEIGE MODAL AN`);
            this.showLimitExceededModal();
        } else {
            console.log(`‚úÖ Feld OK bei Focus (${fieldValue.length} Zeichen)`);
        }
    }

    // Blur Event Handler
    handleFieldBlur(event) {
        console.log(`üîÑ Feld verlassen: ${event.target.id}`);
        this.activeField = null;
        this.closeLimitModal();
    }

    // Input Event Handler f√ºr Bemerkungsfelder
    handleBemerkungInput(event) {
        const inputField = event.target;
        const currentLength = inputField.value.length;
        
        console.log(`‚å®Ô∏è Input Event:`);
        console.log(`   - Feld: ${inputField.id}`);
        console.log(`   - L√§nge: ${currentLength}`);
        console.log(`   - Aktives Feld: ${this.activeField?.id || 'null'}`);
        console.log(`   - System initialisiert: ${this.isInitialized}`);
        
        // Nur verarbeiten wenn das Feld aktiv ist UND System initialisiert
        if (!this.isInitialized) {
            console.log(`‚ùå System noch nicht initialisiert - ignoriere Input`);
            return;
        }
        
        if (this.activeField !== inputField) {
            console.log(`‚ùå Feld nicht aktiv - ignoriere Input`);
            return;
        }
        
        if (currentLength > this.characterLimit) {
            console.warn(`üö®üö®üö® LIMIT √úBERSCHRITTEN DURCH EINGABE!`);
            console.warn(`   - Feld: ${inputField.id}`);
            console.warn(`   - Wert: "${inputField.value}"`);
            console.warn(`   - L√§nge: ${currentLength} (Limit: ${this.characterLimit})`);
            console.warn(`   ‚û°Ô∏è K√úRZE TEXT UND ZEIGE MODAL`);
            
            this.truncateFieldContent(inputField);
            this.showLimitExceededModal();
        } else if (currentLength >= this.warningThreshold) {
            console.log(`‚ö†Ô∏è Warnung: ${inputField.id} hat ${currentLength} Zeichen`);
            this.showWarningState(inputField);
        } else {
            console.log(`‚úÖ OK: ${inputField.id} hat ${currentLength} Zeichen`);
            this.clearWarningState(inputField);
            this.closeLimitModal();
        }
    }

    // Paste Event Handler
    handlePasteEvent(event) {
        const inputField = event.target;
        
        if (!this.isInitialized || this.activeField !== inputField) {
            return;
        }
        
        const pastedText = (event.clipboardData || window.clipboardData).getData('text');
        const currentText = inputField.value;
        const selectionStart = inputField.selectionStart || 0;
        const selectionEnd = inputField.selectionEnd || 0;
        
        const beforeSelection = currentText.substring(0, selectionStart);
        const afterSelection = currentText.substring(selectionEnd);
        const resultingText = beforeSelection + pastedText + afterSelection;
        
        console.log(`üìã Paste Event:`);
        console.log(`   - Eingef√ºgter Text: "${pastedText}"`);
        console.log(`   - Resultierende L√§nge: ${resultingText.length}`);
        
        if (resultingText.length > this.characterLimit) {
            console.warn(`üö® PASTE W√úRDE LIMIT √úBERSCHREITEN!`);
            event.preventDefault();
            this.showLimitExceededModal();
        }
    }

    // Keyboard Event Handler
    handleKeyDown(event) {
        const inputField = event.target;
        
        if (!this.isInitialized || this.activeField !== inputField) {
            return;
        }
        
        const currentLength = inputField.value.length;
        const allowedKeys = ['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Tab', 'Enter'];
        
        if (currentLength >= this.characterLimit && !allowedKeys.includes(event.key) && !event.ctrlKey && !event.metaKey) {
            console.warn(`üö® TASTENDRUCK BLOCKIERT! Taste: ${event.key}, L√§nge: ${currentLength}`);
            event.preventDefault();
            this.showLimitExceededModal();
        }
    }

    // Feld-Inhalt k√ºrzen
    truncateFieldContent(inputField) {
        const originalLength = inputField.value.length;
        if (originalLength > this.characterLimit) {
            const originalValue = inputField.value;
            inputField.value = inputField.value.substring(0, this.characterLimit);
            console.log(`‚úÇÔ∏è Text gek√ºrzt von ${originalLength} auf ${this.characterLimit} Zeichen`);
        }
    }

    // Warning State
    showWarningState(inputField) {
        inputField.classList.add('bemerkung-character-warning');
    }

    clearWarningState(inputField) {
        inputField.classList.remove('bemerkung-character-warning');
    }

    // Modal Event Listeners einrichten
    setupModalEventListeners() {
        const modal = document.getElementById('bemerkungLimitModal');
        const closeBtn = document.getElementById('bemerkungModalCloseBtn');
        const okBtn = document.getElementById('bemerkungModalOkBtn');
        
        console.log(`üîß Modal Setup - Modal gefunden: ${!!modal}`);
        
        if (!modal) {
            console.error('‚ùå‚ùå‚ùå KRITISCHER FEHLER: Modal "bemerkungLimitModal" nicht gefunden!');
            console.error('Stellen Sie sicher, dass das Modal im HTML vorhanden ist!');
            return;
        }
        
        // Buttons pr√ºfen
        if (!closeBtn) console.warn('‚ö†Ô∏è Close Button nicht gefunden');
        if (!okBtn) console.warn('‚ö†Ô∏è OK Button nicht gefunden');
        
        // Close Button
        if (closeBtn) {
            closeBtn.addEventListener('click', (e) => {
                console.log('üîò Close Button geklickt');
                e.preventDefault();
                e.stopPropagation();
                this.closeLimitModal();
            });
        }
        
        // OK Button  
        if (okBtn) {
            okBtn.addEventListener('click', (e) => {
                console.log('üîò OK Button geklickt');
                e.preventDefault();
                e.stopPropagation();
                this.closeLimitModal();
            });
        }
        
        // Overlay Click
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                console.log('üîò Modal Overlay geklickt');
                this.closeLimitModal();
            }
        });
        
        // ESC-Taste
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modal.style.display === 'flex') {
                console.log('üîò ESC-Taste gedr√ºckt');
                this.closeLimitModal();
            }
        });
    }

    // Modal anzeigen
    showLimitExceededModal() {
        console.log(`üì±üì±üì± showLimitExceededModal aufgerufen`);
        console.log(`   - Aktives Feld: ${this.activeField?.id || 'KEIN AKTIVES FELD'}`);
        console.log(`   - System initialisiert: ${this.isInitialized}`);
        
        if (!this.isInitialized) {
            console.log(`‚ùå System noch nicht initialisiert - Modal wird NICHT angezeigt`);
            return;
        }
        
        if (!this.activeField) {
            console.log(`‚ùå Kein aktives Feld - Modal wird NICHT angezeigt`);
            return;
        }
        
        const modal = document.getElementById('bemerkungLimitModal');
        if (modal) {
            console.log(`‚úÖ Zeige Modal an`);
            modal.style.display = 'flex';
            modal.style.visibility = 'visible';
            document.body.classList.add('bemerkung-modal-open');
        } else {
            console.error(`‚ùå Modal Element nicht gefunden!`);
        }
    }

    // Modal schlie√üen
    closeLimitModal() {
        console.log(`üîí closeLimitModal aufgerufen`);
        const modal = document.getElementById('bemerkungLimitModal');
        if (modal) {
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
            document.body.classList.remove('bemerkung-modal-open');
            console.log(`‚úÖ Modal geschlossen`);
        }
    }

    // Observer f√ºr dynamisch hinzugef√ºgte Bemerkungsfelder
    setupDynamicFieldObserver() {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        const newBemerkungFields = node.querySelectorAll ? 
                            node.querySelectorAll('.bemerkung-input') : [];
                        
                        newBemerkungFields.forEach(field => {
                            if (!this.monitoredFields.has(field)) {
                               
                                this.addFieldMonitoring(field);
                            }
                        });
                        
                        if (node.matches && node.matches('.bemerkung-input')) {
                            if (!this.monitoredFields.has(node)) {
                              
                                this.addFieldMonitoring(node);
                            }
                        }
                    }
                });
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });
    }

    // Cleanup
    destroy() {
        console.log('üßπ Cleanup durchgef√ºhrt');
        this.forceHideModal();
        this.monitoredFields.clear();
        this.activeField = null;
        this.isInitialized = false;
    }
}

// Globale Instanz erstellen
let bemerkungLimitMonitor;

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        bemerkungLimitMonitor = new BemerkungTextLimitMonitor();
    });
} else {
    bemerkungLimitMonitor = new BemerkungTextLimitMonitor();
}